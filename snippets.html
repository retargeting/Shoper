<!-- RA::helpers & embedding -->
<script>
function _ra_queryApi(method, params) {
	if (typeof method === 'undefined') return false;
	params = JSON.stringify(params || '');
	var _ra_js = document.createElement("script");
	_ra_js.type ="text/javascript";
	_ra_js.async = true;
	_ra_js.src = "https://plugins.retargeting.biz/shoper-dev/api.php?method="+method+"&shop="+encodeURI(window.location.host)+"&params="+params;
	var s = document.getElementsByTagName("script")[0];
	document.getElementsByTagName("head")[0].appendChild(_ra_js);
}
// RA::embedd
_ra_queryApi( 'embedd' );
_ra_queryApi( 'querySelector', {"selector": "sandokan"} );
var _ra = _ra || {};

function _ra_helper_addLoadEvent(a){var b=window.onload;"function"!=typeof window.onload?window.onload=a:window.onload=function(){b&&b(),a()}}


function _ra_value_sanitize(text) {
	if ( text !== undefined && text !== null ) {
		return text.replace(/([-~!@#$%^&*()_+=`{}\[\]\|\\:;'"<>,.\/? ])+/g, '-').replace(/(-)+/g,'').replace(/^(-)+|(-)+$/g,'')
	} else {
		return false;
	}
}
</script>

<!-- ******************************************** -->

<!-- RA::generalMethods -->

<script>
// RA::setEmail
document.addEventListener('DOMContentLoaded', function() {
	if ( shoper.getVisitorId() !== null ) {
		_ra_queryApi(
			'setEmail',
			{id: shoper.getVisitorId()}
		);
	}
});

// RA::sendCategory
var _raCategory = document.querySelector('[id^=shop_category]');

if ( _raCategory !== null ) {
	var _raCategoryId = _raCategory.getAttribute('id').split('shop_category')[1];
		_ra_queryApi(
			'sendCategory',
			{id: _raCategoryId}
		);
}

// RA::sendBrand
var _raBrand = document.querySelector('[id^=shop_product_producer]');

if ( _raBrand !== null ) {
	var _raBrandId = _raBrand.getAttribute('id').split('shop_product_producer')[1];
		_ra_queryApi(
			'sendBrand', 
			{id: _raBrandId}
		);
}


// RA::addToCart
[].forEach.call(document.querySelectorAll('.product-main-box .addtobasket'), function(el) {
  el.addEventListener('click', function() {
    var _raProductId = '{product_id}';
    var _raQuantity = document.querySelector('.product-main-box input[name="quantity"').value;
    var _raStock = '{stock}';

	if ( _raProductId == '' || _raProductId === null ) {
		var _raProduct = document.querySelector('[id^=shop_product]');
		var _raProductId = _raProduct.getAttribute('id').split('shop_product')[1];
	}

	if ( _raStock > 0 || _raStock !== null || _raStock !== undefined ) {
		var _raStock = 1;
	} else {
		var _raStock = 0;
	}

	if ( _raProductId !== null ) {
		var _raVariations = document.querySelectorAll('select[id*="option_"]');
		var _raArrayCode = [];
		var _raArrayDetails = [];

		for ( var i = 0; i < _raVariations.length; i++ ) {
			

			var _raVariationsId = _raVariations[i].parentElement.getAttribute('class').split('option_')[1];

			if ( _raVariationsId !== null ) {
				var _raVarType = _raVariationsId.replace(/\s/g,'');
				var _raObjectValue = null;
				var _raObjectLabel = null;

				if ( _raVarType === 'color' ) {
					var _raElement = _raVariations[i];

					if( _raElement.selectedIndex > 0 ) {
						var _raObjectValue = _raElement.options[ _raElement.selectedIndex ].text ? _ra_value_sanitize(_raElement.options[ _raElement.selectedIndex ].text) : _ra_value_sanitize(_raElement.value);
						var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
					}
				} else if ( _raVarType === 'select' ) {
					var _raElement = _raVariations[i];

					if( _raElement.selectedIndex > 0) {
						var _raObjectValue = _raElement.options[ _raElement.selectedIndex ].text ? _ra_value_sanitize(_raElement.options[ _raElement.selectedIndex ].text) : _ra_value_sanitize(_raElement.value);
						var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
					}
				} else if ( _raVarType === 'checkbox') {
					var _raElement = _raVariations[i];
					var _raObjectValue = document.querySelector('input[type="checkbox"]:checked').getAttribute('id') ? 1 : 0;
					var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
				} else if ( _raVarType === 'radio') {
					var _raElement = _raVariations[i];
					var _raObjectValue = document.querySelector('input[type="radio"]:checked').getAttribute('id') ? 1 : 0;
					var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
				} else {
					console.log('Variation type is not supported!');
					var _raObjectValue = "";					
				}	
			}

			if ( _raObjectValue !== "" || _raObjectCategory !== null ) {

				var _raObjectValue = _ra_value_sanitize( _raObjectValue );
					_raArrayCode.push(_raObjectValue);
					_raArrayDetails[_raObjectValue] = {
						"category_name": _raObjectCategory, 
						"category": _ra_value_sanitize( _raObjectCategory ), 
						"value": _raObjectValue
				};
			}
		}

		var _ra_Variation = false;
		if ( _raArrayCode.length > 0 ) {
			_ra_Variation = {
				"code": _raArrayCode.join("-"),
				"stock": _raStock,
				"details": _raArrayDetails
			};		
		}

		if (_ra.ready !== undefined) {
			_ra.addToCart( _raProductId, _raQuantity, _ra_Variation);
		}
	}
  })
});

// RA::removeFromCart
var _raRemoveFromCartBtns = document.getElementsByClassName('prodremove');
for(var i = 0; i < _raRemoveFromCartBtns.length; i++) {
	_raRemoveFromCartBtns[i].addEventListener('click', function(){
		_raProductId = this.parentNode.parentNode.getAttribute('data-product-id');
		
		if ( _raRemoveFromCartBtns !== false && _raRemoveFromCartBtns !== undefined ) {
			if ( _ra.ready !== undefined ) {
				_ra.removeFromCart( _raProductId, 1, false);
			}
		}
	});
}

// RA::visitHelpPages
_ra_queryApi(
	'visitHelpPages',
	{id: window.location.pathname}
	);

// RA::checkoutIds
_ra_helper_addLoadEvent(function(){

function setCookie(cname, cvalue) {
    var d = new Date();
    d.setTime(d.getTime() + (1*24*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + ";path=/";
}
	setCookie('_raCheckoutIds_c', shoper.getBasketProducts());

});

var _raCheckoutIds = window.location.pathname.match(/[a-zA-Z]+\/basket/);

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length,c.length);
        }
    }
    return "";
}


if (_raCheckoutIds !== null) {

	var _ra = _ra || {};
		_ra.checkoutIdsInfo = getCookie('_raCheckoutIds_c').split(',');
		console.log(_ra.checkoutIdsInfo);
	    if (_ra.ready !== undefined) {
	        _ra.checkoutIds(_ra.checkoutIdsInfo);
	    }
}


// RA::setCartUrl
if ( _raCheckoutIds !== null ) {
	var _ra = _ra || {};
	_ra.setCartUrlInfo = {
		"url": window.location.origin + window.location.pathname
	};

	if (_ra.ready !== undefined) {
		_ra.setCartUrl(_ra.setCartUrlInfo.url);
	}
}
</script>

<!-- ******************************************** -->

<!-- RA::productMethods -->
<script>


_ra_helper_addLoadEvent(function() {

	var _raProductId = '{product_id}';

	if( _raProductId == '' || _raProductId === null ) {
		_raProduct = document.querySelector('[id^=shop_product]');
		_raProductId = _raProduct.getAttribute('id').split('shop_product')[1];
	}


	_ra_queryApi(
		'sendProduct',
		{id: _raProductId}
	);



	// RA::setVariation
	var _raVariations = document.querySelectorAll('select[id*="option_"]');

	for ( var i = 0; i < _raVariations.length; i++ ) {

		var _raVariationsId = _raVariations[i].parentElement.getAttribute('class').split('option_')[1];

		if ( _raVariationsId !== null ) {
			var _raVarType = _raVariationsId.replace(/\s/g,'');

			if ( _raVarType === 'file' ) {
				var _raElement = _raVariations[i].addEventListener('change', function() {
					if ( _ra.ready !== undefined) {
						_ra_setVariation();
					}
				});
			} else if ( _raVarType === 'text' ) {
				var _raElement = _raVariations[i].addEventListener('change', function() {
					if ( _ra.ready !== undefined) {
						_ra_setVariation();
					}
				});			
			} else if ( _raVarType === 'radio' ) {
				var _raElement = _raVariations[i].addEventListener('click', function() {
					if ( _ra.ready !== undefined) {
						_ra_setVariation();
					}
				});			
			} else if ( _raVarType === 'select' ) {
				var _raElement = _raVariations[i].addEventListener('change', function() {
					if ( _ra.ready !== undefined) {
						_ra_setVariation();
					}
				});			
			} else if ( _raVarType === 'checkbox' ) {
				var _raElement = _raVariations[i].addEventListener('change', function() {
					if ( _ra.ready !== undefined) {
						_ra_setVariation();
					}
				});			
			} else if ( _raVarType === 'color' ) {
				var _raColor = document.querySelectorAll('.stock-color a');
				for ( var j = 0; j < _raColor.length; j++ ) {
					_raColor[j].addEventListener('click', function() {
						if ( _ra.ready !== undefined) {
							_ra_setVariation();
						}					
					});
				}		
			}
		}
	}


	function _ra_setVariation() {
		var _raProductId = '{product_id}';
		var _raStock = true;

		if ( _raProductId == '' || _raProductId === null ) {
			var _raProduct = document.querySelector('[id^=shop_product]');
			var _raProductId = _raProduct.getAttribute('id').split('shop_product')[1];		
		}

		if ( _raProductId !== null ) {

			var _raVariations = document.querySelectorAll('[id*="option_"]');
			var _raArrayCode = [];
			var _raArrayDetails = [];

			for ( var i = 0; i < _raVariations.length; i++ ) {
				var _raVariationsId = _raVariations[i].parentElement.getAttribute('class').split('option_')[1];

				if ( _raVariations !== null ) {
					var _raVarType = _raVariationsId.replace(/\s/g,'');
					var _raObjectValue = null;
					var _raObjectCategory = null;

					if ( _raVarType === 'radio' ) {
						var _raElement = _raVariations[i];
						var _raObjectValue = document.querySelector('input[type="radio"]:checked').getAttribute('id') ? 1 : 0;
						var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
					} else if ( _raVarType === 'select' ) {
						var _raElement = _raVariations[i];

						if( _raElement.selectedIndex > 0) {
							var _raObjectValue = _raElement.options[ _raElement.selectedIndex ].text ? _ra_value_sanitize(_raElement.options[ _raElement.selectedIndex ].text) : _ra_value_sanitize(_raElement.value);
							var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
						}
					} else if ( _raVarType === 'checkbox' ) {
						var _raElement = _raVariations[i];
						var _raObjectValue = document.querySelector('input[type="checkbox"]:checked').getAttribute('id') ? 1 : 0;
						var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
					} else if ( _raVarType === 'color' ) {
						var _raElement = _raVariations[i];

						if( _raElement.selectedIndex > 0 ) {
							var _raObjectValue = _raElement.options[ _raElement.selectedIndex ].text ? _ra_value_sanitize(_raElement.options[ _raElement.selectedIndex ].text) : _ra_value_sanitize(_raElement.value);
							var _raObjectCategory = document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText != '' ? document.querySelector('label[for="'+_raElement.getAttribute('name')+'"]').innerText : 'unknown';
						}
					} else {
						console.log('Variation type is not supported!');
						var _raObjectValue = "";
					}

					if ( _raObjectValue !== "" && _raObjectCategory !== null ) {
						_raObjectValue = _ra_value_sanitize( _raObjectValue );
						_raArrayCode.push( _raObjectValue );
						_raArrayDetails[_raObjectValue] = {
							"category_name": _raObjectCategory,
							"category": _ra_value_sanitize( _raObjectCategory ),
							"value": _raObjectValue
						};
					}
				}			
			}

			var _raVariation = false;
			if ( _raArrayCode.length > 0 ) {
				_raVariation = {
					"code": _raArrayCode.join("-"),
					"stock": _raStock,
					"details": _raArrayDetails
				};

				if ( _ra.ready !== undefined ) {
					_ra.setVariation( _raProductId, _raVariation );
				}
			}
		}
	}

	// RA::clickImage
	var imgSelector = _ra_queryApi("clickImageQS", {"selector": "clickImage"}) || '.mainimg';
	
			document.querySelector(imgSelector).addEventListener('mouseover', function(ev) {
			var _raProductId = _raProductId || null;
	
			if ( _raProductId !== null ) {
				if ( _ra.ready !== undefined ) {
					_ra.clickImage( _raProductId );
				}
			}
		});

	// RA::commentOnProduct
		document.querySelector('form[action*="comment/add"] [type="submit"]').addEventListener('click', function(ev) {
		var _raProductId = _raProductId || null;

		if ( _raProductId !== null ) {
			if ( _ra.ready !== undefined ) {
				_ra.commentOnProduct( _raProductId );
			}
		}
	});

	// RA::likeFacebook
	if (typeof FB != "undefined") {
		FB.Event.subscribe("edge.create", function () {
			var _raProductId = _raProductId || null;

			if ( _raProductId !== null) {
				if (_ra.ready !== undefined) {
					_ra.likeFacebook( _raProductId );
				}
			}
		});
	};

	// RA::addToWishlist
	document.querySelector('.addtofav').addEventListener('click', function() {
		var _raProductId = '{product_id}';

		if ( _raProductId == '' || _raProductId === null ) {
			var _raProduct = document.querySelector('[id^=shop_product]');
			var _raProductId = _raProduct.getAttribute('id').split('shop_product')[1];
		}

		if ( _raProductId !== null ) {
			if ( _ra.ready !== undefined ) {
				_ra.addToWishlist( _raProductId );
			}
		}
	});
});	

</script>

<!-- ******************************************** -->

<!-- RA::orderMethods -->
<script>
// RA::saveOrder
_ra_queryApi('saveOrder', {id: "{if order_id}{order_id}{else}Error: non-existant variable{/if}"});
function _ra_saveOrder(discountValue) {
	_ra.saveOrderInfo = {
		"order_no": "{if order_id}{order_id}{else}Error: non-existant variable{/if}",
		"lastname": "{if bill_lastname}{bill_lastname}{else}Error: non-existant variable{/if}",
		"firstname": "{if bill_firstname}{bill_firstname}{else}Error: non-existant variable{/if}",
		"email": "{if email}{email}{else}Error: non-existant variable{/if}",
		"phone": "{if phone_1}{phone_1}{/if}",
		"state": "{if bill_country}{bill_country}{/if}",
		"city": "{if bill_city}{bill_city}{/if}",
		"address": "{if deliv_street_1}{deliv_street_1}{/if}{if deliv_street_2} {deliv_street_2}{/if}",
		"discount_code": "{if discount_code}{discount_code}{else}{/if}",
		"discount": discountValue,
		"shipping": "{if float_shipping_cost}{float_shipping_cost}{else}0{/if}",
		"rebates": 0,
        "fees": 0,
		"total": "{if float_sum}{float_sum}{else}Error: non-existant variable{/if}"
	};
	_ra.saveOrderProducts = [
		{products}
		    {
				"id": "{products.product_id}",
				"quantity": {products.quantity},
				"price": "{products.float_price}",
				"variation_code": [{products.options}"{products.options.value}", {/products.options}].join('-')
			},
		{/products}
	];

	if( _ra.ready !== undefined ){
		_ra.saveOrder(_ra.saveOrderInfo, _ra.saveOrderProducts);
	}
}
</script>
